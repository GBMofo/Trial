-- === SERVICES ===
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local StarterGui = game:GetService("StarterGui")
local GuiService = game:GetService("GuiService")
local TextService = game:GetService("TextService")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- === OPTIMIZED CONFIG ===
local maxDistance = 12
local maxESP = 2
local nearbyDistance = 8
local updateInterval = 3.5
local plantCheckDelay = 45
local nearbyUpdateInterval = 2.5
local maxNearbyPlants = 8
local cacheUpdateInterval = 15

-- === PERFORMANCE OPTIMIZATION ===
local lastDescendantsUpdate = 0
local plantCache = {}
local lastNearbyUpdate = 0

-- === PLANT CACHING SYSTEM ===
local function updatePlantCache()
    if tick() - lastDescendantsUpdate < cacheUpdateInterval then return end
    lastDescendantsUpdate = tick()
    
    plantCache = {}
    for _, obj in ipairs(workspace:GetChildren()) do
        if obj:IsA("Model") and cropSet[obj.Name:lower()] then
            table.insert(plantCache, obj)
        end
    end
end

-- === NOTIFICATION SYSTEM ===
local notificationPool
local function showNotification(message)
    if notificationPool and notificationPool.Parent then
        notificationPool.Visible = true
        notificationPool.TextLabel.Text = message
    else
        local screenGui = LocalPlayer.PlayerGui:FindFirstChild("PlantESPSelector")
        if not screenGui then return end
        
        notificationPool = Instance.new("Frame")
        notificationPool.Name = "Notification"
        notificationPool.Size = UDim2.new(0, 300, 0, 50)
        notificationPool.Position = UDim2.new(0.5, -150, 0.1, 0)
        notificationPool.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        notificationPool.BackgroundTransparency = 0.3
        notificationPool.BorderSizePixel = 0
        notificationPool.ZIndex = 100
        notificationPool.Visible = false
        notificationPool.Parent = screenGui
        
        local corner = Instance.new("UICorner", notificationPool)
        corner.CornerRadius = UDim.new(0, 8)
        
        local stroke = Instance.new("UIStroke", notificationPool)
        stroke.Color = Color3.fromRGB(255, 50, 50)
        stroke.Thickness = 2
        
        local label = Instance.new("TextLabel", notificationPool)
        label.Name = "TextLabel"
        label.Size = UDim2.new(1, -10, 1, -10)
        label.Position = UDim2.new(0, 5, 0, 5)
        label.BackgroundTransparency = 1
        label.Text = message
        label.TextColor3 = Color3.new(1, 1, 1)
        label.Font = Enum.Font.SourceSansBold
        label.TextSize = 18
        label.TextWrapped = true
    end

    notificationPool.BackgroundTransparency = 1
    notificationPool.TextLabel.TextTransparency = 1
    notificationPool.Visible = true

    local fadeIn = TweenService:Create(
        notificationPool,
        TweenInfo.new(0.5),
        {BackgroundTransparency = 0.3}
    )
    
    local textFadeIn = TweenService:Create(
        notificationPool.TextLabel,
        TweenInfo.new(0.5),
        {TextTransparency = 0}
    )
    
    fadeIn:Play()
    textFadeIn:Play()
    
    task.delay(3, function()
        if notificationPool and notificationPool.Parent then
            local fadeOut = TweenService:Create(
                notificationPool,
                TweenInfo.new(0.5),
                {BackgroundTransparency = 1}
            )
            
            local textFadeOut = TweenService:Create(
                notificationPool.TextLabel,
                TweenInfo.new(0.5),
                {TextTransparency = 1}
            )
            
            fadeOut:Play()
            textFadeOut:Play()
            
            fadeOut.Completed:Wait()
            notificationPool.Visible = false
        end
    end)
end

-- === CROP CATEGORIES & COLORS ===
local cropCategories = {
    Obtainable = {
        Common = {"Carrot", "Strawberry"},
        Uncommon = {"Blueberry", "Manuka Flower", "Orange Tulip", "Rose", "Lavender"},
        Rare = {"Tomato", "Corn", "Dandelion", "Daffodil", "Nectarshade", "Raspberry", "Foxglove"},
        Legendary = {"Watermelon", "Pumpkin", "Apple", "Bamboo", "Lilac", "Lumira"},
        Mythical = {"Coconut", "Cactus", "Dragon Fruit", "Honeysuckle", "Mango", "Nectarine", "Peach", "Pineapple", "Pink Lily", "Purple Dahlia"},
        Divine = {"Grape", "Mushroom", "Pepper", "Cacao", "Hive Fruit", "Sunflower"},
        Prismatic = {"Beanstalk", "Ember Lily"},
    },
    Unobtainable = {
        Common = {"Chocolate Carrot"},
        Uncommon = {"Red Lollipop", "Nightshade"},
        Rare = {"Candy Sunflower", "Mint", "Glowshroom", "Pear"},
        Legendary = {"Cranberry", "Durian", "Easter Egg", "Papaya"},
        Mythical = {"Celestiberry", "Blood Banana", "Moon Melon", "Eggplant", "Passionfruit", "Lemon", "Banana"},
        Divine = {"Cherry Blossom", "Crimson Vine", "Candy Blossom", "Lotus", "Venus Fly Trap", "Cursed Fruit", "Soul Fruit", "Mega Mushroom", "Moon Blossom", "Moon Mango"},
    }
}

-- Create lookup table with original case names
local originalCaseMap = {}
for _, rarities in pairs(cropCategories) do
    for _, crops in pairs(rarities) do
        for _, crop in ipairs(crops) do
            originalCaseMap[crop:lower()] = crop
        end
    end
end

local cropSet = {}
for obtain, rarities in pairs(cropCategories) do
    for rarity, crops in pairs(rarities) do
        for _, crop in ipairs(crops) do
            cropSet[crop:lower()] = {obtain=obtain, rarity=rarity, original=crop}
        end
    end
end

local rarityOrder = {"Common","Uncommon","Rare","Legendary","Mythical","Divine","Prismatic"}
local rarityColors = {
    Common = Color3.fromRGB(180, 180, 180),
    Uncommon = Color3.fromRGB(80, 200, 80),
    Rare = Color3.fromRGB(80, 120, 255),
    Legendary = Color3.fromRGB(255, 215, 0),
    Mythical = Color3.fromRGB(255, 100, 255),
    Divine = Color3.fromRGB(255, 90, 90),
    Prismatic = Color3.fromRGB(100,255,255),
}

-- === LOAD MODULES ===
local CalculatePlantValue
if ReplicatedStorage:FindFirstChild("Modules") and ReplicatedStorage.Modules:FindFirstChild("CalculatePlantValue") then
    CalculatePlantValue = require(ReplicatedStorage.Modules.CalculatePlantValue)
end

-- === OPTIMIZED UTILITY FUNCTIONS ===
local function getPP(model)
    return model.PrimaryPart or model:FindFirstChildWhichIsA("BasePart")
end

-- === ADD MISSING VALUES WITH CACHE ===
spawn(function()
    while task.wait(plantCheckDelay) do
        updatePlantCache()
        for _, model in ipairs(plantCache) do
            if not model:FindFirstChild("Item_String") then
                local itemString = Instance.new("StringValue", model)
                itemString.Name = "Item_String"
                itemString.Value = model.Name
            end

            if not model:FindFirstChild("Variant") then
                local variant = Instance.new("StringValue", model)
                variant.Name = "Variant"
                variant.Value = "Normal"
            end

            if not model:FindFirstChild("Weight") then
                local weight = Instance.new("NumberValue", model)
                weight.Name = "Weight"
                weight.Value = 3.4
            end
        end
    end
end)

-- === NUMBER FORMATTING FUNCTION ===
local function formatPriceWithCommas(n)
    local formatted = tostring(math.floor(n))
    while true do
        formatted, k = formatted:gsub("^(-?%d+)(%d%d%d)", "%1,%2")
        if k == 0 then break end
    end
    return formatted .. "$"
end

-- === ESP CREATION ===
local espMap = {}
local lastUpdate = 0

local function createESP(model, labelText)
    -- Reuse existing ESP if possible
    local existingESP = model:FindFirstChild("PlantESP")
    if existingESP then
        local textLabel = existingESP:FindFirstChildWhichIsA("TextLabel")
        if textLabel then
            textLabel.Text = labelText
            espMap[model] = textLabel
            return textLabel
        end
    end

    local pp = getPP(model)
    if not pp then return end

    local bg = Instance.new("BillboardGui", model)
    bg.Name = "PlantESP"
    bg.Adornee = pp
    bg.Size = UDim2.new(0, 200, 0, 16)
    bg.StudsOffset = Vector3.new(0, 4, 0)
    bg.AlwaysOnTop = true
    bg.MaxDistance = 80

    local tl = Instance.new("TextLabel", bg)
    tl.Size = UDim2.new(1, 0, 1, 0)
    tl.BackgroundTransparency = 1
    tl.TextColor3 = Color3.new(1, 1, 1)
    tl.Font = Enum.Font.FredokaOne
    tl.TextSize = 10
    tl.TextWrapped = false
    tl.RichText = true
    tl.Text = labelText
    tl.TextStrokeColor3 = Color3.new(0, 0, 0)
    tl.TextStrokeTransparency = 0.3
    tl.TextXAlignment = Enum.TextXAlignment.Center

    espMap[model] = tl
    return tl
end

local function cleanup(validModels)
    for model, gui in pairs(espMap) do
        if not validModels[model] and gui.Parent then
            gui:Destroy()
            espMap[model] = nil
        end
    end
    collectgarbage("step", 256)
end

-- === OPTIMIZED NEARBY PLANTS DISPLAY ===
local NearbyFrame
local NearbyScroll
local nearbyLabels = {}
local nearbyList = table.create(maxNearbyPlants)

local function updateNearbyPlants()
    if not NearbyScroll or tick() - lastNearbyUpdate < nearbyUpdateInterval then 
        return 
    end
    lastNearbyUpdate = tick()

    local char = LocalPlayer.Character
    local root = char and char:FindFirstChild("HumanoidRootPart")
    if not root then return end

    -- Reset list
    for i = 1, maxNearbyPlants do
        nearbyList[i] = nil
    end
    
    local foundCount = 0
    local maxDistSq = nearbyDistance * nearbyDistance
    
    for _, model in ipairs(plantCache) do
        local pp = getPP(model)
        if pp then
            local distSq = (pp.Position - root.Position).MagnitudeSquared
            if distSq <= maxDistSq then
                foundCount += 1
                nearbyList[foundCount] = {model=model, dist=math.sqrt(distSq)}
                if foundCount >= maxNearbyPlants then break end
            end
        end
    end

    if foundCount > maxNearbyPlants then
        table.sort(nearbyList, function(a,b) return a.dist < b.dist end)
    end

    for i = 1, maxNearbyPlants do
        local data = nearbyList[i]
        if data then
            local label = nearbyLabels[i]
            if not label then
                label = Instance.new("TextLabel", NearbyScroll)
                label.Size = UDim2.new(1, -4, 0, 14)
                label.BackgroundTransparency = 1
                label.TextWrapped = false
                label.Font = Enum.Font.SourceSansBold
                label.TextSize = 10
                nearbyLabels[i] = label
            end
            
            -- Use original case name for display
            local originalName = originalCaseMap[data.model.Name:lower()] or data.model.Name
            local cropInfo = cropSet[data.model.Name:lower()]
            local rarity = cropInfo and cropInfo.rarity or "Common"
            label.TextColor3 = rarityColors[rarity] or Color3.new(1,1,1)
            label.Text = string.format("%s (%.1f)", originalName, data.dist)
            label.Visible = true
        elseif nearbyLabels[i] then
            nearbyLabels[i].Visible = false
        end
    end
end
-- === MAIN UPDATE LOOP ===
local selectedTypes = {}
for _, v in pairs(cropSet) do
    selectedTypes[v.original:lower()] = true
end

local function update()
    local currentTime = tick()
    if currentTime - lastUpdate < updateInterval then return end
    lastUpdate = currentTime
    updatePlantCache()

    local validModels = {}
    local char = LocalPlayer.Character
    local root = char and char:FindFirstChild("HumanoidRootPart")
    if not root then return end

    local nearest = table.create(maxESP * 2)
    local foundCount = 0
    local maxDistSq = maxDistance * maxDistance
    
    for _, model in ipairs(plantCache) do
        -- Use lower case for comparison
        if selectedTypes[model.Name:lower()] then
            local pp = getPP(model)
            if pp then
                local distSq = (pp.Position - root.Position).MagnitudeSquared
                if distSq <= maxDistSq then
                    foundCount += 1
                    nearest[foundCount] = {model=model, distSq=distSq}
                    if foundCount >= maxESP * 2 then break end
                end
            end
        end
    end

    if foundCount > maxESP then
        table.sort(nearest, function(a,b) return a.distSq < b.distSq end)
    end

    for i = 1, math.min(foundCount, maxESP) do
        local model = nearest[i].model

        local weightObj = model:FindFirstChild("Weight")
        local weight = weightObj and weightObj.Value and string.format("%.1f", weightObj.Value) or "?"

        -- Use original case name
        local originalName = originalCaseMap[model.Name:lower()] or model.Name
        local cropInfo = cropSet[model.Name:lower()]
        local rarity = cropInfo and cropInfo.rarity or "Common"
        local color = rarityColors[rarity] or Color3.new(1,1,1)
        local hexColor = string.format("#%02X%02X%02X", math.floor(color.r * 255), math.floor(color.g * 255), math.floor(color.b * 255))

        local price
        if CalculatePlantValue then
            if typeof(CalculatePlantValue) == "table" and CalculatePlantValue.Calculate then
                price = CalculatePlantValue.Calculate(model)
            elseif typeof(CalculatePlantValue) == "function" then
                price = CalculatePlantValue(model)
            end
        end

        local formattedPrice = price and formatPriceWithCommas(price) or "?"

        local label = string.format(
            "<font color='%s'>%s</font> - %s kg - <font color='#50FF50'>%s</font>",
            hexColor, originalName, weight, formattedPrice
        )

        local espLabel = createESP(model, label)
        if espLabel then
            espLabel.RichText = true
        end
        validModels[model] = true
    end

    cleanup(validModels)
    updateNearbyPlants()
end

-- === THROTTLED UPDATE LOOP ===
RunService.Heartbeat:Connect(function()
    pcall(update)
end)

-- === UI SETUP ===
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "PlantESPSelector"
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- Main Frame with rounded corners and border
local Frame = Instance.new("Frame", ScreenGui)
Frame.Size = UDim2.new(0, 340, 0, 250)
Frame.Position = UDim2.new(0, 10, 0, 60)
Frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
Frame.BackgroundTransparency = 0.3
Frame.Active = true
Frame.Draggable = true

-- Add rounded corners to main frame
local frameCorner = Instance.new("UICorner", Frame)
frameCorner.CornerRadius = UDim.new(0, 8)

-- Add border to main frame
local frameStroke = Instance.new("UIStroke", Frame)
frameStroke.Color = Color3.fromRGB(255, 50, 50)
frameStroke.Thickness = 2
frameStroke.Transparency = 0.2

-- TitleBar
local TitleBar = Instance.new("Frame", Frame)
TitleBar.Size = UDim2.new(1, 0, 0, 22)
TitleBar.Position = UDim2.new(0, 0, 0, 0)
TitleBar.BackgroundTransparency = 0.25
TitleBar.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
TitleBar.BorderSizePixel = 0

-- Discord Button with rounded corners and border
local DiscordBtn = Instance.new("TextButton", TitleBar)
DiscordBtn.Size = UDim2.new(0, 60, 0, 18)
DiscordBtn.Position = UDim2.new(0, 4, 0.5, -9)
DiscordBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
DiscordBtn.Text = "DISCORD"
DiscordBtn.TextColor3 = Color3.new(1, 1, 1)
DiscordBtn.Font = Enum.Font.SourceSansBold
DiscordBtn.TextSize = 10
DiscordBtn.AutoButtonColor = false
DiscordBtn.ZIndex = 20

-- Add rounded corners to Discord button
local DiscordCorner = Instance.new("UICorner", DiscordBtn)
DiscordCorner.CornerRadius = UDim.new(0, 4)

-- Add border to Discord button
local DiscordStroke = Instance.new("UIStroke", DiscordBtn)
DiscordStroke.Color = Color3.fromRGB(255, 50, 50)
DiscordStroke.Thickness = 2

-- Discord button functionality with cooldown
local lastDiscordClick = 0
DiscordBtn.MouseButton1Click:Connect(function()
    if tick() - lastDiscordClick < 1 then return end
    lastDiscordClick = tick()
    
    pcall(function()
        showNotification("Joining PUNK TEAM Discord...")
        
        local success = pcall(function()
            GuiService:OpenBrowserWindow("https://discord.gg/JxEjAtdgWD")
        end)
        
        if not success then
            success = pcall(function()
                StarterGui:SetCore("OpenBrowserWindow", {
                    URL = "https://discord.gg/JxEjAtdgWD"
                })
            end)
        end
        
        if not success then
            pcall(function()
                setclipboard("https://discord.gg/JxEjAtdgWD")
                showNotification("Discord link copied to clipboard!")
            end)
        end
    end)
end)

DiscordBtn.MouseEnter:Connect(function()
    DiscordBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
end)

DiscordBtn.MouseLeave:Connect(function()
    DiscordBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
end)

-- Title
local Title = Instance.new("TextLabel", TitleBar)
Title.Size = UDim2.new(1, -80, 1, 0)
Title.Position = UDim2.new(0, 70, 0, 0)
Title.BackgroundTransparency = 1
Title.Text = "PUNK TEAM Grow Garden ESP"
Title.TextColor3 = Color3.new(1, 1, 1)
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 14
Title.TextXAlignment = Enum.TextXAlignment.Left

-- LegendCol (Rarity Colors)
local LegendCol = Instance.new("Frame", Frame)
LegendCol.Size = UDim2.new(0, 65, 0, 174)
LegendCol.Position = UDim2.new(0, 0, 0, 22)
LegendCol.BackgroundTransparency = 0.2
LegendCol.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
LegendCol.BorderSizePixel = 0

-- Add rounded corners and border
local legendCorner = Instance.new("UICorner", LegendCol)
legendCorner.CornerRadius = UDim.new(0, 6)
local legendStroke = Instance.new("UIStroke", LegendCol)
legendStroke.Color = Color3.fromRGB(255, 50, 50)
legendStroke.Thickness = 1
legendStroke.Transparency = 0.3

local LegendLabel = Instance.new("TextLabel", LegendCol)
LegendLabel.Size = UDim2.new(1, 0, 0, 16)
LegendLabel.Position = UDim2.new(0, 0, 0, 0)
LegendLabel.BackgroundTransparency = 1
LegendLabel.Text = "RARITY"
LegendLabel.TextColor3 = Color3.fromRGB(255,255,255)
LegendLabel.Font = Enum.Font.SourceSansBold
LegendLabel.TextSize = 12

local LegendListLayout = Instance.new("UIListLayout", LegendCol)
LegendListLayout.Padding = UDim.new(0, 2)
LegendListLayout.SortOrder = Enum.SortOrder.LayoutOrder

local rarityFullNames = {}
for _, rarity in ipairs(rarityOrder) do
    local label = Instance.new("TextLabel", LegendCol)
    label.Size = UDim2.new(1, 0, 0, 14)
    label.BackgroundTransparency = 1
    label.Text = rarity
    label.TextColor3 = rarityColors[rarity]
    label.Font = Enum.Font.SourceSansBold
    label.TextSize = 12
    rarityFullNames[rarity] = label
end

-- ObtainCol (Obtainable Crops)
local ObtainCol = Instance.new("Frame", Frame)
ObtainCol.Size = UDim2.new(0, 120, 0, 174)
ObtainCol.Position = UDim2.new(0, 65, 0, 22)
ObtainCol.BackgroundTransparency = 0.2
ObtainCol.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
ObtainCol.BorderSizePixel = 0

-- Add rounded corners and border
local obtainCorner = Instance.new("UICorner", ObtainCol)
obtainCorner.CornerRadius = UDim.new(0, 6)
local obtainStroke = Instance.new("UIStroke", ObtainCol)
obtainStroke.Color = Color3.fromRGB(255, 50, 50)
obtainStroke.Thickness = 1
obtainStroke.Transparency = 0.3

local ObtainLabel = Instance.new("TextLabel", ObtainCol)
ObtainLabel.Size = UDim2.new(1, 0, 0, 16)
ObtainLabel.Position = UDim2.new(0, 0, 0, 0)
ObtainLabel.BackgroundTransparency = 1
ObtainLabel.Text = "Obtainable"
ObtainLabel.TextColor3 = Color3.fromRGB(90, 255, 90)
ObtainLabel.Font = Enum.Font.SourceSansBold
ObtainLabel.TextSize = 12

local ObtainScroll = Instance.new("ScrollingFrame", ObtainCol)
ObtainScroll.Size = UDim2.new(1, 0, 1, -16)
ObtainScroll.Position = UDim2.new(0, 0, 0, 16)
ObtainScroll.CanvasSize = UDim2.new(0, 0, 0, 800)
ObtainScroll.BackgroundTransparency = 1
ObtainScroll.ScrollBarThickness = 4

local ObtainListLayout = Instance.new("UIListLayout", ObtainScroll)
ObtainListLayout.Padding = UDim.new(0, 1)

-- UnobtainCol (Unobtainable Crops)
local UnobtainCol = Instance.new("Frame", Frame)
UnobtainCol.Size = UDim2.new(0, 120, 0, 174)
UnobtainCol.Position = UDim2.new(0, 185, 0, 22)
UnobtainCol.BackgroundTransparency = 0.2
UnobtainCol.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
UnobtainCol.BorderSizePixel = 0

-- Add rounded corners and border
local unobtainCorner = Instance.new("UICorner", UnobtainCol)
unobtainCorner.CornerRadius = UDim.new(0, 6)
local unobtainStroke = Instance.new("UIStroke", UnobtainCol)
unobtainStroke.Color = Color3.fromRGB(255, 50, 50)
unobtainStroke.Thickness = 1
unobtainStroke.Transparency = 0.3

local UnobtainLabel = Instance.new("TextLabel", UnobtainCol)
UnobtainLabel.Size = UDim2.new(1, 0, 0, 16)
UnobtainLabel.Position = UDim2.new(0, 0, 0, 0)
UnobtainLabel.BackgroundTransparency = 1
UnobtainLabel.Text = "Unobtainable"
UnobtainLabel.TextColor3 = Color3.fromRGB(255, 180, 90)
UnobtainLabel.Font = Enum.Font.SourceSansBold
UnobtainLabel.TextSize = 12

local UnobtainScroll = Instance.new("ScrollingFrame", UnobtainCol)
UnobtainScroll.Size = UDim2.new(1, 0, 1, -16)
UnobtainScroll.Position = UDim2.new(0, 0, 0, 16)
UnobtainScroll.CanvasSize = UDim2.new(0, 0, 0, 800)
UnobtainScroll.BackgroundTransparency = 1
UnobtainScroll.ScrollBarThickness = 4

local UnobtainListLayout = Instance.new("UIListLayout", UnobtainScroll)
UnobtainListLayout.Padding = UDim.new(0, 1)

-- NearbyFrame (Nearby Plants List)
NearbyFrame = Instance.new("Frame", Frame)
NearbyFrame.Size = UDim2.new(0, 275, 0, 24)
NearbyFrame.Position = UDim2.new(0, 65, 1, -76)
NearbyFrame.BackgroundTransparency = 0.3
NearbyFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
NearbyFrame.BorderSizePixel = 0

-- Add rounded corners and border
local nearbyCorner = Instance.new("UICorner", NearbyFrame)
nearbyCorner.CornerRadius = UDim.new(0, 6)
local nearbyStroke = Instance.new("UIStroke", NearbyFrame)
nearbyStroke.Color = Color3.fromRGB(255, 50, 50)
nearbyStroke.Thickness = 1
nearbyStroke.Transparency = 0.3

local NearbyLabel = Instance.new("TextLabel", NearbyFrame)
NearbyLabel.Size = UDim2.new(1, 0, 0, 12)
NearbyLabel.Position = UDim2.new(0, 0, 0, 0)
NearbyLabel.BackgroundTransparency = 1
NearbyLabel.Text = "Nearby"
NearbyLabel.TextColor3 = Color3.fromRGB(255,255,255)
NearbyLabel.Font = Enum.Font.SourceSansBold
NearbyLabel.TextSize = 11

NearbyScroll = Instance.new("ScrollingFrame", NearbyFrame)
NearbyScroll.Size = UDim2.new(1, 0, 1, -12)
NearbyScroll.Position = UDim2.new(0, 0, 0, 12)
NearbyScroll.CanvasSize = UDim2.new(0, 0, 0, 100)
NearbyScroll.BackgroundTransparency = 1
NearbyScroll.ScrollBarThickness = 2

local NearbyListLayout = Instance.new("UIListLayout", NearbyScroll)
NearbyListLayout.Padding = UDim.new(0, 1)

-- InputFrame (Distance Settings)
local InputFrame = Instance.new("Frame", Frame)
InputFrame.Size = UDim2.new(0, 275, 0, 30)
InputFrame.Position = UDim2.new(0, 65, 1, -42)
InputFrame.BackgroundTransparency = 0.3
InputFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
InputFrame.BorderSizePixel = 0

-- Add rounded corners and border
local inputCorner = Instance.new("UICorner", InputFrame)
inputCorner.CornerRadius = UDim.new(0, 6)
local inputStroke = Instance.new("UIStroke", InputFrame)
inputStroke.Color = Color3.fromRGB(255, 50, 50)
inputStroke.Thickness = 1
inputStroke.Transparency = 0.3

local inputLabels = {"Max Dist", "Max ESP", "Nearby Dist"}
local inputVars = {"maxDistance", "maxESP", "nearbyDistance"}
local inputValues = {maxDistance, maxESP, nearbyDistance}
local inputLabelsTbl = {}
local inputBoxes = {}

for i, labelName in ipairs(inputLabels) do
    local colWidth = 275 / #inputLabels
    local xPos = (i-1) * colWidth
    local label = Instance.new("TextLabel", InputFrame)
    label.Size = UDim2.new(0, colWidth, 0, 12)
    label.Position = UDim2.new(0, xPos, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = labelName
    label.TextColor3 = Color3.fromRGB(255,255,255)
    label.Font = Enum.Font.SourceSansBold
    label.TextSize = 11
    label.TextXAlignment = Enum.TextXAlignment.Center
    table.insert(inputLabelsTbl, label)

    local box = Instance.new("TextBox", InputFrame)
    box.Size = UDim2.new(0, colWidth - 4, 0, 16)
    box.Position = UDim2.new(0, xPos + 2, 0, 12)
    box.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    box.TextColor3 = Color3.new(1, 1, 1)
    box.Text = tostring(inputValues[i])
    box.Font = Enum.Font.SourceSansBold
    box.TextSize = 12
    box.ClearTextOnFocus = false
    box.TextStrokeTransparency = 0.5
    box.TextWrapped = false
    box.PlaceholderText = "Enter number"

    box.FocusLost:Connect(function(enterPressed)
        local val = tonumber(box.Text)
        if val and val > 0 then
            if inputVars[i] == "maxDistance" then
                maxDistance = val
            elseif inputVars[i] == "maxESP" then
                maxESP = math.floor(val)
            elseif inputVars[i] == "nearbyDistance" then
                nearbyDistance = val
            end
            box.Text = tostring(val)
        else
            box.Text = tostring(inputValues[i])
        end
    end)

    table.insert(inputBoxes, box)
end

-- === TOGGLE BUTTONS WITH THROTTLING ===
local lastToggleClick = 0
local function createToggles()
    for _, child in ipairs(ObtainScroll:GetChildren()) do
        if child:IsA("TextButton") then child:Destroy() end
    end
    for _, child in ipairs(UnobtainScroll:GetChildren()) do
        if child:IsA("TextButton") then child:Destroy() end
    end

    -- Build crop lists using original case names
    local cropsByCategory = {
        Obtainable = {},
        Unobtainable = {}
    }
    
    for obtain, rarities in pairs(cropCategories) do
        for rarity, crops in pairs(rarities) do
            for _, cropName in ipairs(crops) do
                cropsByCategory[obtain][rarity] = cropsByCategory[obtain][rarity] or {}
                table.insert(cropsByCategory[obtain][rarity], cropName)
            end
        end
    end

    -- Function to create toggle buttons using original names
    local function createCropToggleButton(parent, cropName, rarity)
        local btn = Instance.new("TextButton", parent)
        btn.Size = UDim2.new(1, -4, 0, 14)
        btn.BackgroundColor3 = rarityColors[rarity] or Color3.fromRGB(50, 80, 50)
        btn.TextColor3 = Color3.new(1, 1, 1)
        btn.Text = cropName -- Use original case name
        btn.AutoButtonColor = true
        btn.TextSize = 10
        btn.Font = Enum.Font.SourceSansBold
        
        local function updateButtonAppearance()
            if selectedTypes[cropName:lower()] then
                btn.BackgroundTransparency = 0.3
                btn.TextTransparency = 0
            else
                btn.BackgroundTransparency = 0.7
                btn.TextTransparency = 0.5
            end
        end
        
        btn.MouseButton1Click:Connect(function()
            if tick() - lastToggleClick < 0.3 then return end
            lastToggleClick = tick()
            selectedTypes[cropName:lower()] = not selectedTypes[cropName:lower()]
            updateButtonAppearance()
        end)
        
        updateButtonAppearance()
        return btn
    end

    -- Create obtainable crop toggles
    for _, rarity in ipairs(rarityOrder) do
        if cropsByCategory.Obtainable[rarity] then
            for _, cropName in ipairs(cropsByCategory.Obtainable[rarity]) do
                createCropToggleButton(ObtainScroll, cropName, rarity)
            end
        end
    end

    -- Create unobtainable crop toggles
    for _, rarity in ipairs(rarityOrder) do
        if cropsByCategory.Unobtainable[rarity] then
            for _, cropName in ipairs(cropsByCategory.Unobtainable[rarity]) do
                createCropToggleButton(UnobtainScroll, cropName, rarity)
            end
        end
    end
end

createToggles()

spawn(function()
    while task.wait(10) do
        createToggles()
    end
end)

-- Initialize Selected Types with lower case
for _, crop in ipairs(cropCategories.Obtainable.Common) do
    selectedTypes[crop:lower()] = true
end
for _, crop in ipairs(cropCategories.Unobtainable.Common) do
    selectedTypes[crop:lower()] = true
end

-- === COMPACT MODE TOGGLE ===
local lastResize = 0
local function createSizeToggleBtn(frame)
    if frame:FindFirstChild("SizeToggleBtn") then
        frame.SizeToggleBtn:Destroy()
    end

    local btn = Instance.new("TextButton")
    btn.Name = "SizeToggleBtn"
    btn.Parent = frame
    btn.Size = UDim2.new(0, 30, 0, 30)
    btn.Position = UDim2.new(1, -36, 0, 2)
    btn.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.Text = "ðŸ”"
    btn.Font = Enum.Font.SourceSansBold
    btn.TextSize = 18
    btn.AutoButtonColor = true
    btn.BackgroundTransparency = 0.13
    btn.ZIndex = 101
    btn.BorderSizePixel = 0

    -- Add rounded corners
    local corner = Instance.new("UICorner", btn)
    corner.CornerRadius = UDim.new(1, 0)

    -- Add border
    local sizeToggleStroke = Instance.new("UIStroke", btn)
    sizeToggleStroke.Color = Color3.fromRGB(255, 50, 50)
    sizeToggleStroke.Thickness = 2

    local compact = false

    btn.MouseButton1Click:Connect(function()
        if tick() - lastResize < 0.5 then return end
        lastResize = tick()
        
        compact = not compact
        if compact then
            -- Compact mode UI adjustments...
        else
            -- Normal mode UI adjustments...
        end
    end)
    return btn
end

local SizeToggleBtn = createSizeToggleBtn(Frame)

-- === TOGGLE BUTTON (SHOW/HIDE UI) ===
local function createToggleBtn(screenGui, frame)
    if screenGui:FindFirstChild("ShowHideESPBtn") then
        screenGui.ShowHideESPBtn:Destroy()
    end

    local ToggleBtn = Instance.new("ImageButton")
    ToggleBtn.Name = "ShowHideESPBtn"
    ToggleBtn.Parent = screenGui
    ToggleBtn.Size = UDim2.new(0, 38, 0, 38)
    ToggleBtn.Position = UDim2.new(0, 6, 0, 6)
    ToggleBtn.BackgroundTransparency = 1
    ToggleBtn.Image = "rbxassetid://131613009113138"
    ToggleBtn.ZIndex = 100

    -- Toggle button functionality...
    return ToggleBtn
end

local ToggleBtn = createToggleBtn(ScreenGui, Frame)
